{% extends "base.html" %} {% block title %}View Table{% endblock %} {% block content
%}
<div>
	<h2>References</h2>
	
    <table>
        <tr>
            <!-- En ole järjestyksestä ihan varma, mutta näytti kutakuinkin sopivalta. -->
            <th>Title</th>
            <th>Author</th>
            <th>Year</th>
            <th>Type</th>
        </tr>
        {% for reference in references %}
            <tr class="reference-row" data-refid="{{ reference.id }}" onclick="toggleDetails(this)"
                data-editor="{{ reference.editor | default('') }}"
                data-journal="{{ reference.journal | default('') }}"
                data-booktitle="{{ reference.booktitle | default('') }}"
                data-series="{{ reference.series | default('') }}"
                data-volume="{{ reference.volume | default('') }}"
                data-number="{{ reference.number | default('') }}"
                data-pages="{{ reference.pages | default('') }}"
                data-month="{{ reference.month | default('') }}"
                data-publisher="{{ reference.publisher | default('') }}"
                data-organization="{{ reference.organization | default('') }}"
                data-address="{{ reference.address | default('') }}"
                data-isbn="{{ reference.isbn | default('') }}"
                data-issn="{{ reference.issn | default('') }}"
                data-doi="{{ reference.doi | default('') }}"
                data-zbl="{{ reference.zbl | default('') }}"
                data-eprint="{{ reference.eprint | default('') }}"
                data-note="{{ reference.note | default('') }}"
                data-annote="{{ reference.annote | default('') }}"
            >
                <td>{{ reference.title }}</td>
                <td>{{ reference.author }}</td>
                <td>{{ reference.year }}</td>
                <td>{{ reference.type }}</td>
            </tr>
            <tr class="button-row" style="display: none;">
                <td colspan="4" style="text-align: center;">
                    <!-- Ei tarvinnut olla yksittäisen BibTexin kopiointia, mutta kaksi nappia näytti paremmalta kuin yksi. -->
                    <!-- Tässä ei ole montaa asiaa samassa taskissa, koska on vain UI:n hahmottelua ilman toimintaa. -->
                    <!-- Tähän saisi ehkä myös edit-napin? Erittäin vaikea kuitenkin toteuttaa editointi tablen sisällä. -->
                    <button class="copy-button" role="button">Copy BibTex to Clipboard</button>
                    <button class="delete-button" id="del_button-{{ reference.id }}" onclick="handleDeleteButtonClick(this)">Delete Reference</button>
                </td>
            </tr>
            <tr class="empty-row"></tr>
        {% endfor %}
    </table>
</div>

<script>
    function toggleDetails(row) {
        var ref_id = row.getAttribute('data-refid');
        var is_detail_row_created = row.classList.contains('detail-created-' + ref_id);

        /* Tämä if else koittaa olla luomasta liikaa ylimääräisiä rivejä. */
        if (!is_detail_row_created) {
            /* Nämä ovat näkymättömiä jos ei referenssillä kyseistä ole. */
            var details = [
                { label: 'Booktitle', value: row.getAttribute('data-booktitle') },
                { label: 'Editor', value: row.getAttribute('data-editor') },
                { label: 'Journal', value: row.getAttribute('data-journal') },
                { label: 'Series', value: row.getAttribute('data-series') },
                { label: 'Volume', value: row.getAttribute('data-volume') },
                { label: 'Number', value: row.getAttribute('data-number') },
                { label: 'Pages', value: row.getAttribute('data-pages') },
                { label: 'Month', value: row.getAttribute('data-month') },
                { label: 'Publisher', value: row.getAttribute('data-publisher') },
                { label: 'Organization', value: row.getAttribute('data-organization') },
                { label: 'address', value: row.getAttribute('data-address') },
                { label: 'ISBN', value: row.getAttribute('data-isbn') },
                { label: 'ISSN', value: row.getAttribute('data-issn') },
                { label: 'DOI', value: row.getAttribute('data-doi') },
                { label: 'Zbl', value: row.getAttribute('data-zbl') },
                { label: 'Eprint', value: row.getAttribute('data-eprint') },
                { label: 'Note', value: row.getAttribute('data-note') },
                { label: 'Annote', value: row.getAttribute('data-annote') },
            ].filter(detail => detail.value);

            var last_inserted_row = row;

            for (var i = 0; i < details.length; i += 4) {
                var label_row = document.createElement('tr');
                label_row.classList.add('reference-details', 'detail-row-' + ref_id, 'reference-details-labels');
                label_row.style.display = '';

                var value_row = document.createElement('tr');
                value_row.classList.add('reference-details', 'detail-row-' + ref_id, 'reference-details-values');
                value_row.style.display = '';

                for (var j = i; j < i + 4 && j < details.length; j++) {
                    label_row.innerHTML += '<td class="type-label">' + details[j].label + '</td>';
                    value_row.innerHTML += '<td>' + details[j].value + '</td>';
                }

                for (var k = j; k < i + 4; k++) {
                    label_row.innerHTML += '<td></td>';
                    value_row.innerHTML += '<td></td>';
                }

                last_inserted_row.parentNode.insertBefore(label_row, last_inserted_row.nextElementSibling);
                last_inserted_row.parentNode.insertBefore(value_row, label_row.nextElementSibling);
                last_inserted_row = value_row;
            }

            var button_row = row.nextElementSibling;
            while (button_row && !button_row.classList.contains('button-row')) {
                button_row = button_row.nextElementSibling;
            }
            if (button_row) {
                button_row.style.display = '';
            }

            row.classList.add('detail-created-' + ref_id);

        } else {
            var current_row = row.nextElementSibling;

            while (current_row && (current_row.classList.contains('detail-row-' + ref_id) || current_row.classList.contains('button-row'))) {
                if (current_row.classList.contains('button-row')) {
                    var deleteButton = current_row.querySelector('.delete-button');
                    if (deleteButton) {
                        deleteButton.textContent = "Delete Reference";
                    }
                }
                current_row.style.display = current_row.style.display === 'none' ? '' : 'none';
                current_row = current_row.nextElementSibling;
            }
                
        }
    }

    function handleDeleteButtonClick(button) {
        if (button.textContent === "Delete Reference") {
            button.textContent = "Are you sure?";
        } else {
            deleteFunction();
        }
    }

    function deleteFunction() {
        /* Tähän delete-toiminto. */
        console.log("delete called");
    }

    /* function handleCopyButtonClick(button) {

    }*/

</script>

{% endblock %}
